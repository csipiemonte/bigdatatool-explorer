var Constants=Constants||{};Constants.KNOX_BASE_URL="knox/gateway/default/webhdfs/v1",Constants.KNOX_OPERATIONS={LIST:"LISTSTATUS",OPEN:"OPEN",GETHOMEDIRECTORY:"GETHOMEDIRECTORY"},Constants.Time={},Constants.Time.ONE_MINUTE=6e4,Constants.Time.ONE_HOUR=36e5,Constants.Time.ONE_DAY=864e5,Constants.Time.ONE_MONTH=26784e5,Constants.Time.ONE_YEAR=31536e6;var bigdataExplorerFilter=angular.module("bigdata-explorer.filters",[]);bigdataExplorerFilter.filter("safeNumber",function(){return function(e,t){var l=e;return isNaN(e)||(isNaN(t)&&(t=0),l=e.toFixed(t)),l}}),bigdataExplorerFilter.filter("format_big_number",function(){return function(e){console.log("input",e);var t="";return e&&(e=Number.parseFloat(e),e<1e3?t=e.toFixed(2):e<1e6?t=(e/1e3).toFixed(2)+" <span class='counter-group'>k</span>":e<1e9?t=(e/1e6).toFixed(2)+" <span class='counter-group'>M</span>":e<1e12&&(t=(e/1e9).toFixed(2)+" <span class='counter-group'>B</span>")),(""+t).replace(".",",")}}),bigdataExplorerFilter.filter("format_filesize",function(){return function(e){var t="";return e&&(e=parseInt(e),e<1e3?t=e+" byte":e<1e6?t=(e/1e3).toFixed(1)+" Kb":e<1e9?t=(e/1e6).toFixed(1)+" Mb":e<1e12&&(t=(e/1e9).toFixed(1)+" Gb")),t}}),angular.module("bigdata-explorer.plugin",["bigdata-explorer","bigdata-explorer.templates","bigdata-explorer.utils","bigdata-explorer.filters","bigdata-explorer.services","base64"]);var bigdataExplorerTemplatesModule=angular.module("bigdata-explorer.templates",["bigdata-explorer.utils"]),bigdataExplorerModule=angular.module("bigdata-explorer",["bigdata-explorer.templates","bigdata-explorer.services"]),bigdataExplorerServices=bigdataExplorerServices||angular.module("bigdata-explorer.services",[]);bigdataExplorerServices.factory("hdfsService",["$http","$base64",function(e,t){var l={};l.getInfo=function(){return"Direcotry List"};var a=function(t,l){"undefined"==typeof l&&(l="");var a=Constants.KNOX_BASE_URL+l+"?op="+t;return e.get(a)};return l.getPath=function(e){return a(Constants.KNOX_OPERATIONS.LIST,e)},l.openFile=function(e){return a(Constants.KNOX_OPERATIONS.OPEN,e)},l.getHomeDirectory=function(e,t){return a(Constants.KNOX_OPERATIONS.GETHOMEDIRECTORY,null)},l}]);var yuccaUtilsModule=angular.module("bigdata-explorer.utils",[]);yuccaUtilsModule.factory("$bigdataExplorerHelpers",[function(){return{attrs:{num:function(e,t,l,a){var n=e;return(isNaN(e)||null==e||""==e||"undefined"!=typeof t&&null!=t&&e<t||"undefined"!=typeof l&&null!=l&&e>l)&&(n=a),n},safe:function(e,t){var l=e;return"undefined"!=typeof e&&null!=e&&""!=e||(l=t),l}},utils:{isEmpty:function(e){return"undefined"==typeof e||null==e},hex2Rgb:function(e){"#"==e.charAt(0)&&(e=e.substring(1,7));var t=parseInt(e.substring(0,2),16),l=parseInt(e.substring(2,4),16),a=parseInt(e.substring(4,6),16);return t+","+l+","+a},formatDateFromMillis:function(e){var t="";if(e){var l=new Date(e),a=l.getDate(),n=l.getMonth()+1,i=l.getFullYear(),o=l.getHours(),r=l.getMinutes();t=""+(a<=9?"0"+a:a)+"/"+(n<=9?"0"+n:n)+"/"+i+" "+(o<=9?"0"+o:o)+":"+(r<=9?"0"+r:r)}return t},lZero:function(e){var t="00";return isNaN(e)||(t=e<=9?"0"+e:e),t},formatData:function(e){var t="";if(e){var l=new Date(e),a=l.getDate(),n=l.getMonth()+1,i=l.getFullYear(),o=l.getHours(),r=l.getMinutes(),s=l.getSeconds();t=""+i+"/"+(n<=9?"0"+n:n)+"/"+(a<=9?"0"+a:a)+" "+(o<=9?"0"+o:o)+":"+(r<=9?"0"+r:r)+":"+(s<=9?"0"+s:s)}return t}},render:{safeTags:function(e){var t="";if("undefined"!=typeof e&&null!=e){var l=typeof e;t="string"==l?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):e}return t},linkify:function(e){var t="";if("undefined"!=typeof e&&null!=e){var l=typeof e;if("string"==l){var a,n,i;a=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,t=e.replace(a,'<a href="$1" target="_blank">$1</a>'),n=/(^|[^\/])(www\.[\S]+(\b|$))/gim,t=t.replace(n,'$1<a href="http://$2" target="_blank">$2</a>'),i=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,t=t.replace(i,'<a href="mailto:$1">$1</a>')}else t=e}return t}}}}]),bigdataExplorerModule.directive("hdfsExplorer",["hdfsService","$bigdataExplorerHelpers",function(e,t){"use strict";return{restrict:"E",scope:{},templateUrl:"template/hdfs-explorer.html",link:function(t,l,a){console.debug("attrs",a),console.debug("hdfsService",e.getInfo()),t.started=!1;var n=a.startpath;t.pathToBrowse=[],t.copyPanel={pathToCopy:null};var i={fullpath:n,pathSuffix:""};console.log("rootFolder",i),t.filetree={viewId:"root_",pathSuffix:n,children:[],fullpath:a.startpath+"/",loadChildren:function(){t.selectNode(this.fullpath)},icon:"glyphicon glyphicon-folder-open",isOpen:!0};var o=function(e){if(t.filemessage=null,t.filelist=[],0==e.children.length)t.filemessage={type:"info",text:"Folder empty"};else for(var l=0;l<e.children.length;l++)"DIRECTORY"==e.children[l].type?(e.children[l].icon="glyphicon glyphicon-folder-close folder-icon",e.children[l].loadChildren=function(){t.selectNode(this)}):(e.children[l].icon="glyphicon glyphicon-file file-icon",e.children[l].pathSuffix.lastIndexOf(".")>=0&&(e.children[l].fileExt=e.children[l].pathSuffix.split(".").pop(),e.children[l].icon+=" icon-"+e.children[l].fileExt)),t.filelist.push(e.children[l])},r=function(e,t){setTimeout(function(){var l=angular.element(document.querySelector("#"+t));console.log("element",t),angular.element(document.querySelector("#"+e))[0].scrollTop=l.prop("offsetTop"),console.log("parent",angular.element(document.querySelector("#"+e)))},0)},s=function(e){if(e.isOpen=!e.isOpen,t.pathToBrowse.length>0){e.isOpen=!0;var l=t.pathToBrowse[0];t.pathToBrowse.shift(),t.selectNode(c(e,l))}else r("folder-tree-panel",e.viewId),t.selectedFolderPath=e.fullpath,console.info("scope.pathToBrowse ",t.pathToBrowse),console.info("selectedFolderPath - ",t.selectedFolderPath)};t.selectNode=function(l){console.debug("fromNode",l),console.debug("fromPath",l.fullpath),console.log("qui"),0==l.children.length?e.getPath(l.fullpath).then(function(e){console.log("response",e.data.FileStatuses.FileStatus),t.list=e.data.FileStatuses.FileStatus;for(var a=0;a<e.data.FileStatuses.FileStatus.length;a++){var n=e.data.FileStatuses.FileStatus[a];n.fullpath=l.fullpath+n.pathSuffix,n.viewId=l.viewId+n.pathSuffix.replace(".","_")+"_","DIRECTORY"==n.type&&(n.fullpath+="/"),n.loadChildren=function(){t.selectNode(this)},n.children=[],l.children.push(n)}o(l),s(l)},function(e){console.error("getPath response error",e),t.filelist=[],t.filemessage={type:"danger",text:"<strong>"+e.status+"</strong> "+e.statusText},s(l)}):(o(l),s(l))};var c=function(e,t){console.log("parentNode",e,t),console.log("path",t);var l=null;if(e&&null!=e)for(var a=0;a<e.children.length;a++)if(e.children[a].pathSuffix==t){l=e.children[a];break}return l};t.browseToHome=function(){e.getHomeDirectory().then(function(e){console.log("response",e),null!=e&&null!=e.data&&null!=e.data.Path&&(t.pathToBrowse=e.data.Path.split("/"),t.pathToBrowse.shift(),t.selectNode(t.filetree))},function(e){console.error("browseToHome response error",e)})},t.browseToPath=function(e){t.pathToBrowse=e.split("/"),t.pathToBrowse.shift(),""==t.pathToBrowse[t.pathToBrowse.length-1]&&t.pathToBrowse.pop(),t.showFavoritePanel=!1,t.selectNode(t.filetree)},t.levelUp=function(e){e&&null!=e&&(e=e.substring(0,e.lastIndexOf("/")),e=e.substring(0,e.lastIndexOf("/")),t.browseToPath(e))},t.start=function(){t.selectNode(t.filetree),t.started=!0},t.start(),t.openFile=function(l){if(!l.fileExt||"jpg"!=l.fileExt&&"tiff"!=l.fileExt&&"gif"!=l.fileExt&&"bmp"!=l.fileExt&&"png"!=l.fileExt&&"jpeg"!=l.fileExt&&"ogg"!=l.fileExt&&"mp4"!=l.fileExt&&"webm"!=l.fileExt&&"mp3"!=l.fileExt&&"aac"!=l.fileExt)e.openFile(l.fullpath).then(function(e){console.log("response",e);var t=new Blob([e.data]),a=angular.element("<a></a>");a.attr("href",window.URL.createObjectURL(t)),a.attr("download",l.pathSuffix),a[0].click()},function(e){console.error("response error",e),t.message={type:"danger",title:"Unable to download the file",text:"<strong>"+e.status+"</strong> "+e.statusText}});else{var a=angular.element("<a></a>");a.attr("href",Constants.KNOX_BASE_URL+l.fullpath+"?op=OPEN"),a.attr("download",l.pathSuffix),a[0].click()}},t.imgFit=function(e){"width"==e?(t.imageFitWidth="100%",t.imageFitHeight="auto"):(t.imageFitWidth="auto",t.imageFitHeight="300px")},t.previewFile=function(l){if(t.imgPreviewUrl=null,!l.fileExt||"jpg"!=l.fileExt&&"tiff"!=l.fileExt&&"gif"!=l.fileExt&&"bmp"!=l.fileExt&&"png"!=l.fileExt&&"jpeg"!=l.fileExt)if(!l.fileExt||"ogg"!=l.fileExt&&"mp4"!=l.fileExt&&"webm"!=l.fileExt)if(!l.fileExt||"mp3"!=l.fileExt&&"aac"!=l.fileExt)e.openFile(l.fullpath).then(function(e){console.log("response",e);var a="";if(l.fileExt&&"csv"==l.fileExt){a="<div class='preview-container'><table class='table table-condensed table-bordered table-preview'><tbody>";for(var n=e.data.match(/[^\r\n]+/g),i=0;i<n.length;i++){a+="<tr>";for(var o=n[i].split(","),r=0;r<o.length;r++)a+="<td>"+o[r]+"</td>";a+="</tr>"}a+="</tbody></table></div>"}else a="<p class='file-preview-body'>"+e.data+"</p>";t.modalPanelContent={title:"Preview of file "+l.pathSuffix,body:a}},function(e){console.error("response error",e),t.message={type:"danger",title:"Unable to create the file preview",text:"<strong>"+e.status+"</strong> "+e.statusText}});else{var a="<p class='file-preview-body'><audio width='320' height='240' controls><source src='"+Constants.KNOX_BASE_URL+l.fullpath+"?op=OPEN'></source></audio></p><p><strong>File name:</strong> "+l.pathSuffix+"</p>";t.modalPanelContent={title:"Preview of file "+l.pathSuffix,body:a}}else{var a="<p class='file-preview-body'><video width='320' height='240' controls><source src='"+Constants.KNOX_BASE_URL+l.fullpath+"?op=OPEN'></source></video></p><p><strong>File name:</strong> "+l.pathSuffix+"</p>";t.modalPanelContent={title:"Preview of file "+l.pathSuffix,body:a}}else t.imgPreviewUrl=Constants.KNOX_BASE_URL+l.fullpath+"?op=OPEN",t.modalPanelContent={title:"Preview of file "+l.pathSuffix,body:""}},t.logout=function(){t.started=!1;$http.defaults.headers.common.Authorization="Basic "},t.refresh=function(){t.filetree.children=[],t.start()},t.supportsStorage=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},t.favoritesPath=[],t.supportsStorage()&&(t.favoritesPath=JSON.parse(localStorage.getItem("favoritesPath")),"undefined"!=typeof t.favoritesPath&&null!=t.favoritesPath||(t.favoritesPath=[])),console.log("scope.favoritesPath",t.favoritesPath),t.addCurrentPathToFavorite=function(){t.selectedFolderPath,t.favoritesPath.indexOf(t.selectedFolderPath)<0&&(t.favoritesPath.push(t.selectedFolderPath),t.favoritesPath.sort(),localStorage.setItem("favoritesPath",JSON.stringify(t.favoritesPath)))},t.removeFavorite=function(e){var l=t.favoritesPath.indexOf(e);l>-1&&(t.favoritesPath.splice(l,1),localStorage.setItem("favoritesPath",JSON.stringify(t.favoritesPath)))},t.copyToClipboard=function(e){t.copyPanel.pathToCopy=e,setTimeout(function(){angular.element(document.querySelector("#copyToClipboardTextArea"))[0].select()},0)},t.selectedFolderPath="",t.filelist=[]}}}]),bigdataExplorerTemplatesModule.run(["$templateCache",function(e){e.put("template/hdfs-explorer.html",'<div class="explorer-header-toolbar clearfix" ng-show="started">\n  <div>\n     <div class="pull-left toolbar-panel"> \n       <a class="" href ng-click="refresh();"><i class="glyphicon glyphicon-refresh"></i> Refresh</a>\n       <a class="" ng-show="supportsStorage()" href ng-click="showFavoritePanel=true"><i class="glyphicon glyphicon-star"></i> Favorites</a> \n     </div>\n     <div class="pull-right">\n     </div>\n  </div>\n</div><div class="explorer-start-panel row" ng-show="!started">\n  <div class="col-sm-8  explorer-start-intro">\n    Insert user and password, or bind them using \n    <a href="http://zeppelin.apache.org/docs/0.6.1/displaysystem/front-end-angular.html" target="_blank"><code>z.angularBind</code></a> if you are using \n    <a hre="https://zeppelin.apache.org/" target="_blank"><strong>Apache Zeppelin</strong></a>\n  </div>\n</div>\n<div class="row explorer-wrapper" ng-show="started">\n  <div class="col-sm-8 col-sm-offset-4">\n    <p><a href ng-click="levelUp(selectedFolderPath)"><i class="glyphicon glyphicon-level-up level-up-icon" ng-show="selectedFolderPath!=\'/\'"></i></a> <strong translate>Full path</strong> <code>{{selectedFolderPath}}</code></p>\n  </div>\n  <div class="col-sm-4 folder-tree-panel" id="folder-tree-panel">\n     <a href ng-click="start()"  ng-class="filetree.fullpath == selectedFolderPath?\'folder-selected\':\'\'">\n  \t\t<i ng-class="filetree.icon" class="item-icon folder-icon"></i> {{filetree.pathSuffix}}<span ng-show="filetree.pathSuffix==\'\'">(root)</span>\n    </a> \n    <ul class="folder-tree-list"> \n      <li ng-repeat="folder in filetree.children | filter : {type: \'DIRECTORY\'} : true track by $index" ng-include="\'template/treefolder-view.html\'" ></li> \n    </ul> \n  </div>\n  <div class="col-sm-8 file-view-panel">\n\t <div class="alert alert-{{filemessage.type}}" role="alert" ng-show="filemessage!=null"><span ng-bind-html="filemessage.text"></span></div>\n    <table class="table table-striped table-condensed" ng-show="filelist.length>0">\n      <thead>\n        <tr><th>&nbsp;</th><th>Name</th><th>Update Date</th><th>Size</th><th>Owner</th><th>Group</th><th>Permission</th><th>Action</th></tr>\n      </thead>\n      <tbody>\n        <tr ng-repeat="file in filelist track by $index">\n \t\t\t<td><i class="{{file.icon}}"></i></td>\n           <td ng-show="file.type==\'DIRECTORY\'"><a href ng-click="file.loadChildren()">{{file.pathSuffix}}</a></td>\n           <td ng-show="file.type!=\'DIRECTORY\'">{{file.pathSuffix}}</td>\n           <td>{{file.modificationTime|date}}</td>\n           <td>{{file.length|format_filesize}}</td>\n           <td>{{file.owner}}</td>\n           <td>{{file.group}}</td>\n           <td>{{file.permission}}</td>\n           <td>\n               <a href ng-click="copyToClipboard(file.fullpath)" title="Copy full path: {{file.fullpath}}" class="file-action-button"><i class="glyphicon glyphicon-copy"></i></a>\n               <a ng-show="file.type!=\'DIRECTORY\'" href ng-click="openFile(file)" title="Open file" class="file-action-button"><i class="glyphicon glyphicon-save"></i></a>\n               <a ng-show="file.type!=\'DIRECTORY\'" href ng-click="previewFile(file)" title="Open file" class="file-action-button"><i class="glyphicon glyphicon-eye-open"></i></a>\n           </td>\n        </tr>\n      </tbody>\n    </table>\n  </div>\n</div>\n<div class="panel panel-{{message.type}} alert-main" ng-show="message!=null">\n  <div class="panel-heading">{{message.title}} <span class="close" ng-click="message = null">&times;</span></div>\n  <div class="panel-body"><p><span ng-bind-html="message.text"></span></p><div class="text-center"><a href ng-click="message = null" class="btn btn-default">Close</a></div></div>\n</div>\n<div class="panel panel-default modal-panel" ng-show="modalPanelContent!=null">\n  <div class="panel-heading">{{modalPanelContent.title}} <span class="close" ng-click="modalPanelContent = null">&times;</span></div>\n  <div class="panel-body">\n    <p ng-show="imgPreviewUrl!=null"><strong>Fit image </strong> \n       <a class="btn btn-default" href ng-click="imgFit(\'width\')"><i class="glyphicon glyphicon-resize-horizontal" alt="width"></i></a> \n       <a  class="btn btn-default" href ng-click="imgFit(\'height\')" alt="height"><i class="glyphicon glyphicon-resize-vertical"></i></a> \n    </p>    <p class="file-preview-body" ng-show="imgPreviewUrl!=null"><img src="{{imgPreviewUrl}}"  width="{{imageFitWidth}}" height="{{imageFitHeight}}"></img></p>\n    <div ng-bind-html="modalPanelContent.body"></div><div class="text-center"><a href ng-click="modalPanelContent = null" class="btn btn-default">Close</a></div>\n  </div>\n</div>\n</div>\n<div class="panel panel-default modal-panel" ng-show="copyPanel.pathToCopy!=null">\n  <div class="panel-heading">Copy full path<span class="close" ng-click="copyPanel.pathToCopy = null">&times;</span></div>\n  <div class="panel-body clipboard-copy-panel">\n    <p><textarea id="copyToClipboardTextArea" readonly >{{copyPanel.pathToCopy}}</textarea> </p>\n    <p><strong>Ctrl+C</strong> <small>to copy</small></p>\n    <div class="text-center"><a href ng-click="copyPanel.pathToCopy = null" class="btn btn-default">Close</a></div>\n </div>\n</div>\n<div class="panel panel-default modal-panel" ng-show="showFavoritePanel">\n  <div class="panel-heading"><i class="glyphicon glyphicon-star"></i> Favorites<span class="close" ng-click="showFavoritePanel=false">&times;</span></div>\n  <div class="panel-body ">\n    <p><ul class="list-group"><li class="list-group-item" ng-repeat="favorite in favoritesPath track by $index">\n        <a href ng-click="browseToPath(favorite)">{{favorite}}</a><a href ng-click="removeFavorite(favorite)" class="pull-right"><i class="glyphicon glyphicon-trash"></i></a>\n    </li></ul></p>\n    <p><a href ng-click="addCurrentPathToFavorite()" class="btn"><i class="glyphicon glyphicon-plus"></i> Add current path to favorite</a></p>\n  <div class="text-center"><a href ng-click="showFavoritePanel = false" class="btn btn-default">Close</a></div></div>\n</div>\n'),e.put("template/treefolder-view.html",'<a   id="{{folder.viewId}}" href ng-click="folder.loadChildren()" ng-class="folder.fullpath == selectedFolderPath?\'folder-selected\':\'\'">\n  <i ng-class="folder.isOpen?\'glyphicon glyphicon-folder-open\':\'glyphicon glyphicon-folder-close\'" class="item-icon folder-icon"></i> {{folder.pathSuffix}}\n</a> \n<ul class="folder-tree-list" ng-show="folder.isOpen"> \n   <li ng-repeat="folder in folder.children | filter : {type: \'DIRECTORY\'} : true track by $index" ng-include="\'template/treefolder-view.html\'">\n   </li>\n</ul> \n')}]);