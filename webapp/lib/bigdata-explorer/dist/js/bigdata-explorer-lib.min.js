var Constants=Constants||{};Constants.KNOX_BASE_URL="https://sdnet-knox.sdp.csi.it:8443/gateway/default/webhdfs/v1/",Constants.KNOX_OPERATIONS={LIST:"LISTSTATUS",OPEN:"OPEN",GETHOMEDIRECTORY:"GETHOMEDIRECTORY"},Constants.Time={},Constants.Time.ONE_MINUTE=6e4,Constants.Time.ONE_HOUR=36e5,Constants.Time.ONE_DAY=864e5,Constants.Time.ONE_MONTH=26784e5,Constants.Time.ONE_YEAR=31536e6;var bigdataExplorerFilter=angular.module("bigdata-explorer.filters",[]);bigdataExplorerFilter.filter("safeNumber",function(){return function(e,t){var n=e;return isNaN(e)||(isNaN(t)&&(t=0),n=e.toFixed(t)),n}}),bigdataExplorerFilter.filter("format_big_number",function(){return function(e){console.log("input",e);var t="";return e&&(e=Number.parseFloat(e),e<1e3?t=e.toFixed(2):e<1e6?t=(e/1e3).toFixed(2)+" <span class='counter-group'>k</span>":e<1e9?t=(e/1e6).toFixed(2)+" <span class='counter-group'>M</span>":e<1e12&&(t=(e/1e9).toFixed(2)+" <span class='counter-group'>B</span>")),(""+t).replace(".",",")}}),bigdataExplorerFilter.filter("format_filesize",function(){return function(e){var t="";return e&&(e=parseInt(e),e<1e3?t=e+" byte":e<1e6?t=(e/1e3).toFixed(1)+" Kb":e<1e9?t=(e/1e6).toFixed(1)+" Mb":e<1e12&&(t=(e/1e9).toFixed(1)+" Gb")),t}}),angular.module("bigdata-explorer.plugin",["bigdata-explorer","bigdata-explorer.templates","bigdata-explorer.utils","bigdata-explorer.filters","bigdata-explorer.services","base64"]);var bigdataExplorerTemplatesModule=angular.module("bigdata-explorer.templates",["bigdata-explorer.utils"]),bigdataExplorerModule=angular.module("bigdata-explorer",["bigdata-explorer.templates","bigdata-explorer.services"]),bigdataExplorerServices=bigdataExplorerServices||angular.module("bigdata-explorer.services",[]);bigdataExplorerServices.factory("hdfsService",["$http","$base64",function(e,t){var n={};n.getInfo=function(){return"Direcotry List"};var l=function(n,l,a,r){"undefined"==typeof r&&(r="");var o=Constants.KNOX_BASE_URL+r+"?op="+n;console.debug("hdfsService.getPath - url",o),console.debug("hdfsService.getPath - username",l),console.debug("hdfsService.getPath - password",a);var i=t.encode(l+":"+a);console.debug("hdfsService.getPath - auth",i);var s={"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Authorization:"Basic "+i,"Access-Control-Allow-Origin":"*"};return e.get(o,{headers:s})};return n.getPath=function(e,t,n){return l(Constants.KNOX_OPERATIONS.LIST,e,t,n)},n.openFile=function(e,t,n){return l(Constants.KNOX_OPERATIONS.OPEN,e,t,n)},n.getHomeDirectory=function(e,t){return l(Constants.KNOX_OPERATIONS.GETHOMEDIRECTORY,e,t,null)},n}]);var yuccaUtilsModule=angular.module("bigdata-explorer.utils",[]);yuccaUtilsModule.factory("$bigdataExplorerHelpers",[function(){return{attrs:{num:function(e,t,n,l){var a=e;return(isNaN(e)||null==e||""==e||"undefined"!=typeof t&&null!=t&&e<t||"undefined"!=typeof n&&null!=n&&e>n)&&(a=l),a},safe:function(e,t){var n=e;return"undefined"!=typeof e&&null!=e&&""!=e||(n=t),n}},utils:{isEmpty:function(e){return"undefined"==typeof e||null==e},hex2Rgb:function(e){"#"==e.charAt(0)&&(e=e.substring(1,7));var t=parseInt(e.substring(0,2),16),n=parseInt(e.substring(2,4),16),l=parseInt(e.substring(4,6),16);return t+","+n+","+l},formatDateFromMillis:function(e){var t="";if(e){var n=new Date(e),l=n.getDate(),a=n.getMonth()+1,r=n.getFullYear(),o=n.getHours(),i=n.getMinutes();t=""+(l<=9?"0"+l:l)+"/"+(a<=9?"0"+a:a)+"/"+r+" "+(o<=9?"0"+o:o)+":"+(i<=9?"0"+i:i)}return t},lZero:function(e){var t="00";return isNaN(e)||(t=e<=9?"0"+e:e),t},formatData:function(e){var t="";if(e){var n=new Date(e),l=n.getDate(),a=n.getMonth()+1,r=n.getFullYear(),o=n.getHours(),i=n.getMinutes(),s=n.getSeconds();t=""+r+"/"+(a<=9?"0"+a:a)+"/"+(l<=9?"0"+l:l)+" "+(o<=9?"0"+o:o)+":"+(i<=9?"0"+i:i)+":"+(s<=9?"0"+s:s)}return t}},render:{safeTags:function(e){var t="";if("undefined"!=typeof e&&null!=e){var n=typeof e;t="string"==n?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):e}return t},linkify:function(e){var t="";if("undefined"!=typeof e&&null!=e){var n=typeof e;if("string"==n){var l,a,r;l=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,t=e.replace(l,'<a href="$1" target="_blank">$1</a>'),a=/(^|[^\/])(www\.[\S]+(\b|$))/gim,t=t.replace(a,'$1<a href="http://$2" target="_blank">$2</a>'),r=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,t=t.replace(r,'<a href="mailto:$1">$1</a>')}else t=e}return t}}}}]),bigdataExplorerModule.directive("hdfsExplorer",["hdfsService","$bigdataExplorerHelpers",function(e,t){"use strict";return{restrict:"E",scope:{},templateUrl:"template/hdfs-explorer.html",link:function(t,n,l){console.debug("attrs",l),console.debug("hdfsService",e.getInfo()),t.started=!1,t.username=l.username;var a=l.password,r=l.startpath;t.pathToBrowse=[];var o={fullpath:r,pathSuffix:""};console.log("rootFolder",o),t.filetree={viewId:"root_",pathSuffix:r,children:[],fullpath:l.startpath+"/",loadChildren:function(){t.selectNode(this.fullpath)},icon:"glyphicon glyphicon-folder-open",isOpen:!0};var i=function(e){if(t.filemessage=null,t.filelist=[],0==e.children.length)t.filemessage={type:"info",text:"Folder empty"};else for(var n=0;n<e.children.length;n++)"DIRECTORY"==e.children[n].type?(e.children[n].icon="glyphicon glyphicon-folder-close folder-icon",e.children[n].loadChildren=function(){t.selectNode(this)}):(e.children[n].icon="glyphicon glyphicon-file file-icon",e.children[n].pathSuffix.lastIndexOf(".")>=0&&(e.children[n].icon+=" icon-"+e.children[n].pathSuffix.split(".").pop())),t.filelist.push(e.children[n])},s=function(e,t){setTimeout(function(){var n=angular.element(document.querySelector("#"+t));console.log("element",t),angular.element(document.querySelector("#"+e))[0].scrollTop=n.prop("offsetTop"),console.log("parent",angular.element(document.querySelector("#"+e)))},0)},c=function(e){if(e.isOpen=!e.isOpen,t.pathToBrowse.length>0){e.isOpen=!0;var n=t.pathToBrowse[0];t.pathToBrowse.shift(),t.selectNode(d(e,n))}else s("folder-tree-panel",e.viewId),t.selectedFolderPath=e.fullpath,console.info("scope.pathToBrowse ",t.pathToBrowse),console.info("selectedFolderPath - ",t.selectedFolderPath)};t.selectNode=function(n){console.debug("fromNode",n),console.debug("fromPath",n.fullpath),console.log("qui"),0==n.children.length?e.getPath(t.username,a,n.fullpath).then(function(e){console.log("response",e.data.FileStatuses.FileStatus),t.list=e.data.FileStatuses.FileStatus;for(var l=0;l<e.data.FileStatuses.FileStatus.length;l++){var a=e.data.FileStatuses.FileStatus[l];a.fullpath=n.fullpath+a.pathSuffix,a.viewId=n.viewId+a.pathSuffix.replace(".","_")+"_","DIRECTORY"==a.type&&(a.fullpath+="/"),a.loadChildren=function(){t.selectNode(this)},a.children=[],n.children.push(a)}i(n),c(n)},function(e){console.error("getPath response error",e),t.filelist=[],t.filemessage={type:"danger",text:"<strong>"+e.status+"</strong> "+e.statusText},c(n)}):(i(n),c(n))};var d=function(e,t){console.log("parentNode",e,t),console.log("path",t);var n=null;if(e&&null!=e)for(var l=0;l<e.children.length;l++)if(e.children[l].pathSuffix==t){n=e.children[l];break}return n};t.browseToHome=function(){e.getHomeDirectory(t.username,a).then(function(e){console.log("response",e),null!=e&&null!=e.data&&null!=e.data.Path&&(t.pathToBrowse=e.data.Path.split("/"),t.pathToBrowse.shift(),t.selectNode(t.filetree))},function(e){console.error("browseToHome response error",e)})},t.browseToPath=function(e){t.pathToBrowse=e.split("/"),t.pathToBrowse.shift(),""==t.pathToBrowse[t.pathToBrowse.length-1]&&t.pathToBrowse.pop(),t.showFavoritePanel=!1,t.selectNode(t.filetree)},t.start=function(){null!=t.username&&""!=t.username?(t.selectNode(t.filetree),t.started=!0):t.started=!1},t.start(),t.openFile=function(n){e.openFile(t.username,a,n.fullpath).then(function(e){console.log("response",e);var t=new Blob([e.data]),l=angular.element("<a></a>");l.attr("href",window.URL.createObjectURL(t)),l.attr("download",n.pathSuffix),l[0].click()},function(e){console.error("response error",e),t.message={type:"danger",title:"Unable to download the file",text:"<strong>"+e.status+"</strong> "+e.statusText}})},t.previewFile=function(n){e.openFile(t.username,a,n.fullpath).then(function(e){console.log("response",e);var n="<p class='file-preview-body'>"+e.data+"</p>";t.modalPanelContent={title:"Preview of file file.pathSuffix",body:n}},function(e){console.error("response error",e),t.message={type:"danger",title:"Unable to create the file preview",text:"<strong>"+e.status+"</strong> "+e.statusText}})},t.logout=function(){t.started=!1,t.username=null;$http.defaults.headers.common.Authorization="Basic "},t.refresh=function(){t.filetree.children=[],t.start()},t.supportsStorage=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},t.favoritesPath=[],t.supportsStorage()&&(t.favoritesPath=JSON.parse(localStorage.getItem("favoritesPath")),"undefined"!=typeof t.favoritesPath&&null!=t.favoritesPath||(t.favoritesPath=[])),console.log("scope.favoritesPath",t.favoritesPath),t.addCurrentPathToFavorite=function(){t.selectedFolderPath,t.favoritesPath.indexOf(t.selectedFolderPath)<0&&(t.favoritesPath.push(t.selectedFolderPath),t.favoritesPath.sort(),localStorage.setItem("favoritesPath",JSON.stringify(t.favoritesPath)))},t.removeFavorite=function(e){var n=t.favoritesPath.indexOf(e);n>-1&&(t.favoritesPath.splice(n,1),localStorage.setItem("favoritesPath",JSON.stringify(t.favoritesPath)))},t.selectedFolderPath="",t.filelist=[]}}}]),bigdataExplorerTemplatesModule.run(["$templateCache",function(e){e.put("template/hdfs-explorer.html",'<div class="explorer-header-toolbar clearfix" ng-show="started">\n  <div>\n     <div class="pull-left toolbar-panel"> \n       <a class="" href ng-click="refresh();"><i class="glyphicon glyphicon-refresh"></i> Refresh</a>\n       <a class="" href ng-click="browseToHome();"><i class="glyphicon glyphicon-home"></i> Home</a> \n       <a class="" ng-show="supportsStorage()" href ng-click="showFavoritePanel=true"><i class="glyphicon glyphicon-star"></i> Favorites</a> \n     </div>\n     <div class="pull-right">\n       <div>User <strong>{{username}}</strong></div>\n       <div><a class="" href ng-click="logout()"><i class="glyphicon glyphicon-log-out"></i> Logout</a></div>\n     </div>\n  </div>\n</div><div class="explorer-start-panel row" ng-show="!started">\n  <div class="col-sm-8  explorer-start-intro">\n    Insert user and password, or bind them using \n    <a href="http://zeppelin.apache.org/docs/0.6.1/displaysystem/front-end-angular.html" target="_blank"><code>z.angularBind</code></a> if you are using \n    <a hre="https://zeppelin.apache.org/" target="_blank"><strong>Apache Zeppelin</strong></a>\n  </div>\n</div>\n<div class="row explorer-wrapper" ng-show="started">\n  <div class="col-sm-8 col-sm-offset-4">\n    <p><strong translate>Full path</strong> <code>{{selectedFolderPath}}</code></p>\n  </div>\n  <div class="col-sm-4 folder-tree-panel" id="folder-tree-panel">\n     <a href ng-click="start()"  ng-class="filetree.fullpath == selectedFolderPath?\'folder-selected\':\'\'">\n  \t\t<i ng-class="filetree.icon" class="item-icon folder-icon"></i> {{filetree.pathSuffix}}<span ng-show="filetree.pathSuffix==\'\'">(root)</span>\n    </a> \n    <ul class="folder-tree-list"> \n      <li ng-repeat="folder in filetree.children | filter : {type: \'DIRECTORY\'} : true track by $index" ng-include="\'template/treefolder-view.html\'" ></li> \n    </ul> \n  </div>\n  <div class="col-sm-8 file-view-panel">\n\t <div class="alert alert-{{filemessage.type}}" role="alert" ng-show="filemessage!=null"><span ng-bind-html="filemessage.text"></span></div>\n    <table class="table table-striped table-condensed" ng-show="filelist.length>0">\n      <thead>\n        <tr><th>&nbsp;</th><th>Name</th><th>Update Date</th><th>Size</th><th>Owner</th><th>Group</th><th>Permission</th><th>Action</th></tr>\n      </thead>\n      <tbody>\n        <tr ng-repeat="file in filelist track by $index">\n \t\t\t<td><i class="{{file.icon}}"></i></td>\n           <td ng-show="file.type==\'DIRECTORY\'"><a href ng-click="file.loadChildren()">{{file.pathSuffix}}</a></td>\n           <td ng-show="file.type!=\'DIRECTORY\'">{{file.pathSuffix}}</td>\n           <td>{{file.modificationTime|date}}</td>\n           <td>{{file.length|format_filesize}}</td>\n           <td>{{file.owner}}</td>\n           <td>{{file.group}}</td>\n           <td>{{file.permission}}</td>\n           <td>\n              <!-- <a href ng-click="copyPath(file.fullpath)" title="Copy full path: {{file.fullpath}}"><i class="glyphicon glyphicon-copy"></i></a> -->\n               <a ng-show="file.type!=\'DIRECTORY\'" href ng-click="openFile(file)" title="Open file" class="file-action-button"><i class="glyphicon glyphicon-save"></i></a>\n               <a ng-show="file.type!=\'DIRECTORY\'" href ng-click="previewFile(file)" title="Open file" class="file-action-button"><i class="glyphicon glyphicon-eye-open"></i></a>\n           </td>\n        </tr>\n      </tbody>\n    </table>\n  </div>\n</div>\n<div class="panel panel-{{message.type}} alert-main" ng-show="message!=null">\n  <div class="panel-heading">{{message.title}} <span class="close" ng-click="message = null">&times;</span></div>\n  <div class="panel-body"><p><span ng-bind-html="message.text"></span></p><div class="text-center"><a href ng-click="message = null" class="btn btn-default">Close</a></div></div>\n</div>\n<div class="panel panel-default modal-panel" ng-show="modalPanelContent!=null">\n  <div class="panel-heading">{{modalPanelContent.title}} <span class="close" ng-click="modalPanelContent = null">&times;</span></div>\n  <div class="panel-body"><p><span ng-bind-html="modalPanelContent.body"></span></p><div class="text-center"><a href ng-click="modalPanelContent = null" class="btn btn-default">Close</a></div></div>\n</div>\n</div>\n<div class="panel panel-default modal-panel" ng-show="showFavoritePanel">\n  <div class="panel-heading"><i class="glyphicon glyphicon-star"></i> Favorites<span class="close" ng-click="showFavoritePanel=false">&times;</span></div>\n  <div class="panel-body">\n    <p><ul class="list-group"><li class="list-group-item" ng-repeat="favorite in favoritesPath track by $index">\n        <a href ng-click="browseToPath(favorite)">{{favorite}}</a><a href ng-click="removeFavorite(favorite)" class="pull-right"><i class="glyphicon glyphicon-trash"></i></a>\n    </li></ul></p>\n    <p><a href ng-click="addCurrentPathToFavorite()" class="btn"><i class="glyphicon glyphicon-plus"></i> Add current path to favorite</a></p>\n  <div class="text-center"><a href ng-click="showFavoritePanel = false" class="btn btn-default">Close</a></div></div>\n</div>\n'),e.put("template/treefolder-view.html",'<a   id="{{folder.viewId}}" href ng-click="folder.loadChildren()" ng-class="folder.fullpath == selectedFolderPath?\'folder-selected\':\'\'">\n  <i ng-class="folder.isOpen?\'glyphicon glyphicon-folder-open\':\'glyphicon glyphicon-folder-close\'" class="item-icon folder-icon"></i> {{folder.pathSuffix}}\n</a> \n<ul class="folder-tree-list" ng-show="folder.isOpen"> \n   <li ng-repeat="folder in folder.children | filter : {type: \'DIRECTORY\'} : true track by $index" ng-include="\'template/treefolder-view.html\'">\n   </li>\n</ul> \n')}]);